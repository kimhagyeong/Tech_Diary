# API 통신 중에 끊김 현상을 없애기 위해 HAProxy를 안태우면 된다?
proxy는 뭐고 HaProxy는 무엇인가?

proxy : 빠른 통신을 위하여 데이터를 임시 저장, 데이터 전송 전용 서버 등으로 사용함. 우회의 용도로 사용되기도 함.  
가령 원본 데이터가 천안에 있고 A라는 사람이 데이터를 복사하여 가방에 넣고 서울에 와서 B가 필요할 때마다 가방에서 데이터를 준다고 할 때 A의 가방은 proxy 서버가 된다.  
이럴 때 B는 데이터가 필요할 때마다 천안에 갈 필요 없이 A의 가방으로 부터 데이터를 얻을 수 있어 빠른 통신 속도를 체험할 수 있게 된다.  


하지만 여기서 원본 데이터가 바뀌었다면? 이것은 proxy 정책에 따라 처리가 다르게 된다.  
https://ko.wikipedia.org/wiki/%ED%94%84%EB%A1%9D%EC%8B%9C_%EC%84%9C%EB%B2%84. 

아파치 웹서버(apache web server) 에는 mod_proxy 라는 모듈에서 forward proxy 와 reverse proxy  두 가지 기능을 제공  
forward proxy는 사용자와 회사 서버 간에 통신에서 사용자가 요청한 데이터들을 캐싱.  
reverse proxy는 사용자가 요청한 데이터가 캐싱에 없을 때 회사 서버에 데이터를 요청해야 하는데 이때 사용하는 프록시.  
보안과 속도를 위해서 reverse proxy를 사용하며 자세한 내용은 여기! : https://www.lesstif.com/system-admin/forward-proxy-reverse-proxy-21430345.html


----
보안과 proxy도 연관되어 있다. 일단, 사내 서버는 보안을 위해 외부 통신을 관리해야 한다. 사내 서버는 다음과 같은 구조이다.

###### node ip <-> vip <-> NAT IP(공개 IP) <-> fire wall <-> 외부

특정 외부망에 도달하기 위해서 지금까지 2가지 방법을 배웠다.
1. proxy를 태움
2. 방화벽을 오픈

-> 1. proxy 태움.  
위 같은 경우는 사내 vm 서비스를 사용하다 보면 외부망이 완벽히 막혀 있어서 외부 라이브러리를 다운받기 어렵다.   
이럴때 특정 프록시는 오픈이 되어 있는데, proxyon을 통해서 오픈을 하면 특정 url 서버 한에서 다운이 가능하다.  


-> 2. 방화벽 오픈.  
사내 노드 ip가 외부 클라우드 (azure) 계정에 접속하기 위해서 도착 ip에 대해서 443, 80번으로 포트 오픈을 한다.  
방화벽 오픈을 한 url에 한에서 서버 인스턴스 attribute에 no_proxy를 태우기도 한다.  
그러면 프록시로 우회하지 않고 이미 열려진 방화벽으로 외부에 접속할 수 있다.



----
사내 서버로 만든 api는 빠른 통신을 위해 proxy를 사용하고 있는데 이때 HAProxy를 사용한다.


HAProxy는 L4, L7 하드웨어 스위치를 소프트웨어로 대처한 로드밸런서라고 볼 수 있는다.  
로드밸런서는 부하 분산을 위해서 가상 IP를 통해 여러 서버에 접속하도록 분배하는 서비스를 말하며 NAT 기능이나 데이터를 캡슐화하는 기능(tunneling) 등이 있다.  
  
###### 사용자 > L4 > NAT(IP/MAC 주소 변조) > real server - 사용자가 L4를 호출하면 중간에 NAT가 목적지 IP 주소를 real server IP 주소로 변조하고 MAC 주소도 변조

vip 방식도 같이보면 좋다. : https://run-it.tistory.com/44

HAProxy는 reverse proxy 형태.  
단, 이미 캐싱 되어 있는 데이터가 불러지면 쿠키 추가 없이 전달되기 때문에 속도 측면에서 우세.  
최초 접근 시 쿠키에 바로 서버 정보를 입력하지 않고 서버에서 jsessionid가 전달될 때 서버 정보를 합쳐서 전달한다.  
그렇기 때문에 대용량의 데이터를 업로드하는 경우 지연이 일어나면서 timeout error가 생기기도 한다.

그런 경우 사내에서는 HAProxy를 태우지 않는 전용 vip 망을 발급받고, 이 vip 망을 개발망, 운영망 등에 포트 오픈을 하여 안정적인 서비스를 제공한다.

